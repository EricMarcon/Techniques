---
title: "Modèle mixte"
lang: fr-FR
# Code options 
# https://quarto.org/docs/computations/execution-options.html#output-options
execute:
  # show code chunk output
  include: true
  # Show the code in the output
  echo: true
  # Show warnings
  warning: false
  # Cache code results
  cache: false
  # option messages is in the Option chunk for R
format: 
  html:
    toc: true
    filters: ["fr-nbsp.lua"]
  pdf: default
editor: visual
---

# 

```{r}
#| label: DoNotModify
#| include: false
### Utilities for R. 
# Do not modify unless you don't use R: then, delete this chunk.
# Installation of R packages if necessary
install_packages <- function(packages) {
  invisible(
    sapply(
      packages, 
      FUN = function(package) {
        if (!package %in% installed.packages()[, 1]) {
          install.packages(package, repos = "https://cran.rstudio.com/")
        }
      }
    )
  )
}

# Basic packages
install_packages(c("knitR", "formatR", "kableExtra"))

# Chunk font size hook: allows size='small' or any valid Latex font size in chunk options
def.chunk.hook <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(
  chunk = function(x, options) {
    x <- def.chunk.hook(x, options)
    ifelse(
      options$size == "normalsize", 
      yes = x,
      no = paste0("\n \\", options$size, "\n\n", x, "\n\n \\normalsize")
    )
  }
)
```

```{r}
#| label: Options
#| include: false
### Customized R options for this document
# Delete this chunk if you don't use R

# Add necessary packages here
packages <- c("tidyverse", "lme4")
# Install them
install_packages(packages)

# knitr options (https://yihui.org/knitr/options/)
knitr::opts_chunk$set(
  # Messages from packages
  message = FALSE,
  # Code chunk automatic format if tidy is TRUE
  tidy = TRUE, 
  # Tidy code options: remove blank lines and cut lines after 50 characters
  tidy.opts = list(blank = FALSE, width.cutoff = 50),
  # Font size in PDF output
  size = "scriptsize", 
  # Select PDF figures in PDF output if PDF file exists beside PNG file
  knitr.graphics.auto_pdf = TRUE
)
# Text width of R functions output
options(width = 50)

# ggplot style
library("tidyverse")
theme_set(theme_bw())
theme_update(
  panel.background = element_rect(fill = "transparent", colour = NA),
  plot.background = element_rect(fill = "transparent", colour = NA)
)
knitr::opts_chunk$set(dev.args = list(bg = "transparent"))

# Random seed
set.seed(973)
```

# Motivation

Estimation d'un modèle mixte simple.

# Données

Un modèle linéaire avec effets aléatoires est simulé: $$y_{i[j]} = \alpha_j + \beta_j x_{i[j]} + \epsilon_{i[j]}$$

Les individus, indicés par $i$ appartiennent à des groupes, indicés par $j$.

```{r}
# Paramètres
n_groupes <- 5
# Effectif moyen par groupe
n_individus_par_groupe <- 20
#  Effectif réel par groupe
n_individus <- rpois(n_groupes, lambda = n_individus_par_groupe)
# Paramètres
sigma <- 1
```

Les données sont simulées par une fonction.

```{r}
library("tidyverse")
sim_data <- function(n_individus, n_groupes, alpha_j, beta_j) {
  n <- sum(n_individus)
  X <- runif(n, 0, 10)
  Y <- rep(alpha_j, n_individus) + rep(beta_j, n_individus) * X + rnorm(n, sd = sigma)
  seq_len(n_groupes) %>% 
    rep(n_individus) %>% 
    as.factor() -> groupe
  return(tibble(X, Y, groupe))
}
```

# Modèle linéaire

Les individus sont tous indépendants dans cette première version du modèle: tous les effets sont fixes.

```{r}
alpha_j <- rep(5, n_groupes)
beta_j <- rep(2, n_groupes)
donnees <- sim_data(n_individus, n_groupes, alpha_j, beta_j)
donnees %>% 
  ggplot(aes(x = X, y = Y)) +
  geom_point() +
  geom_smooth(method = "lm")
```

L'estimation utilise la fonction `lm()` du package `stats`.

```{r}
modele_lm <- lm(Y ~ X, data = donnees)
summary(modele_lm)
```

# Effets aléatoires

Les individus appartiennent à des groupes pour lesquels à la fois l'ordonnée à l'origine et la pente du modèle sont des effets aléatoires, distribués normalement autour des valeurs du modèle précédent.

```{r}
alpha_j <- rnorm(n_groupes, mean = 5, sd = 5)
beta_j <- rnorm(n_groupes, mean = 2, sd = 5)
donnees <- sim_data(n_individus, n_groupes, alpha_j, beta_j)
donnees %>% 
  ggplot(aes(x = X, y = Y, color = groupe)) +
  geom_point() +
  geom_smooth(method = "lm")
```

L'estimation est faite avec le package lme4.

```{r}
library("lme4")
modele <- lmer(Y ~ (1|groupe) + (X||groupe), data = donnees)
summary(modele)
```
